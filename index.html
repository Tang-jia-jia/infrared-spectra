<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢å¤–è°±å›¾æ•°æ®åº“</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .search-box {
            text-align: center;
            margin-bottom: 30px;
        }
        input[type="text"] {
            width: 60%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2980b9;
        }
        .compound-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .compound-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .compound-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .compound-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .compound-formula {
            color: #7f8c8d;
            font-style: italic;
        }
        #plotly-chart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        .loading {
            text-align: center;
            padding: 100px;
            color: #999;
            font-size: 18px;
        }
        /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
        .download-buttons {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .download-buttons button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 14px;
        }
        .btn-csv {
            background: #27ae60 !important;
        }
        .btn-csv:hover {
            background: #219a52 !important;
        }
        .btn-png {
            background: #e74c3c !important;
        }
        .btn-png:hover {
            background: #c0392b !important;
        }
    </style>
</head>
<body>
    <h1>çº¢å¤–è°±å›¾æ•°æ®åº“</h1>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢æ ·å“åç§°">
        <button onclick="searchCompounds()">æœç´¢</button>
    </div>
    <!-- åœ¨æœç´¢æ¡†ä¸‹æ–¹æ·»åŠ ä¸Šä¼ åŒºåŸŸ -->
<div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 30px 0;">
    <h3 style="margin-top:0; color: #2e7d32;">ğŸ”¼ ä¸Šä¼ æ–°æ ·å“</h3>
    <form id="uploadForm" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="file" id="csvFile" accept=".csv" style="flex:1; min-width: 200px; padding: 8px;">
        <input type="text" id="formulaInput" placeholder="åˆ†å­å¼ï¼ˆå¦‚C6H6ï¼‰" style="flex:1; min-width: 150px; padding: 8px;">
        <button type="submit" style="background: #27ae60; padding: 10px 20px;">ä¸Šä¼ </button>
    </form>
    <div id="uploadStatus" style="margin-top: 15px; font-size: 14px; min-height: 20px;"></div>
</div>

    <div id="compoundList" class="compound-list"></div>

    <div id="plotly-chart" style="display:none;">
        <h2 id="chart-title"></h2>
        <div id="chart"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="toggleModeBtn" onclick="toggleYAxisMode()">åˆ‡æ¢åˆ°å¸å…‰åº¦</button>
        </div>
    </div>

    <!-- åŠ è½½ç´¢å¼•å’Œçƒ­æ•°æ® -->
    <script src="spectra_index.js"></script>
    <script src="spectra_hot.js"></script>

    <script>
        // ============================================================================
        // æ ¸å¿ƒçŠ¶æ€ç®¡ç†
        // ============================================================================
        let currentMode = 'transmittance';
        let currentCompound = null;
        let spectraCache = {};  // å†·æ•°æ®ç¼“å­˜

        // ============================================================================
        // æ•°æ®è½¬æ¢å‡½æ•°
        // ============================================================================
        function transmittance_to_absorbance(T) {
            if (T <= 0) return 4;
            return -Math.log10(T / 100);
        }

        // ============================================================================
        // åˆå§‹åŒ–
        // ============================================================================
        if (typeof spectraIndex !== 'undefined' && spectraIndex.length > 0) {
            displayCompounds(spectraIndex);
        } else {
            document.getElementById('compoundList').innerHTML =
                '<div style="color:red; text-align:center; padding:50px;">é”™è¯¯ï¼šæ— æ³•åŠ è½½åŒ–åˆç‰©ç´¢å¼•</div>';
        }

        // ============================================================================
        // æ˜¾ç¤ºåŒ–åˆç‰©åˆ—è¡¨
        // ============================================================================
        function displayCompounds(indexData) {
            const listDiv = document.getElementById('compoundList');
            listDiv.innerHTML = '';

            if (indexData.length === 0) {
                listDiv.innerHTML = '<div style="text-align:center; color:#666; padding:50px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŒ–åˆç‰©</div>';
                return;
            }

            indexData.forEach(compound => {
                const card = document.createElement('div');
                card.className = 'compound-card';
                card.innerHTML = `
                    <div class="compound-name">${compound.name}</div>
                    <div class="compound-formula">${compound.formula}</div>
                `;
                card.onclick = () => loadAndShowSpectrum(compound);
                listDiv.appendChild(card);
            });
        }

        // ============================================================================
        // åŠ è½½è°±å›¾æ•°æ®ï¼ˆæ··åˆæ–¹æ¡ˆæ ¸å¿ƒï¼‰
        // ============================================================================
        function loadAndShowSpectrum(compoundInfo) {
            const fileName = compoundInfo.file;

            // å¼ºåˆ¶æ¸…é™¤æ—§çŠ¶æ€
            currentCompound = null;
            const chartDiv = document.getElementById('chart');
            const titleDiv = document.getElementById('chart-title');

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.getElementById('plotly-chart').style.display = 'block';
            titleDiv.textContent = `${compoundInfo.name} (${compoundInfo.formula})`;
            chartDiv.innerHTML = '<div class="loading">è°±å›¾åŠ è½½ä¸­...</div>';

            // ============================================================================
            // çƒ­æ•°æ®åˆ†æ”¯
            // ============================================================================
            if (compoundInfo.is_hot && typeof spectraHot !== 'undefined') {
                const hotData = spectraHot.find(c => c.name === compoundInfo.name);
                if (hotData) {
                    setTimeout(() => {
                        currentCompound = hotData;
                        showSpectrum(hotData);
                    }, 10);
                    return;
                }
            }

            // ============================================================================
            // å†·æ•°æ®åˆ†æ”¯
            // ============================================================================
            if (spectraCache[fileName]) {
                setTimeout(() => {
                    currentCompound = spectraCache[fileName];
                    showSpectrum(spectraCache[fileName]);
                }, 10);
                return;
            }

            // åŠ è½½å†·æ•°æ®JSON
            fetch(`spectra/${fileName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${fileName}`);
                    }
                    return response.json();
                })
                .then(data => {
                    spectraCache[fileName] = data;
                    currentCompound = data;
                    showSpectrum(data);
                })
                .catch(error => {
                    console.error("âŒ åŠ è½½å¤±è´¥:", error);
                    chartDiv.innerHTML = `<div style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                });
        }

        // ============================================================================
        // æ˜¾ç¤ºè°±å›¾ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šdtickåˆ»åº¦ + æ¸…é™¤åŠ è½½çŠ¶æ€ï¼‰
        // ============================================================================
        function showSpectrum(compound) {
            // é˜²å¾¡æ€§æ£€æŸ¥
            if (!compound || !Array.isArray(compound.x) || !Array.isArray(compound.y)) {
                document.getElementById('chart').innerHTML =
                    '<div style="color:red; padding:50px; text-align:center;">é”™è¯¯: æ•°æ®æ ¼å¼ä¸æ­£ç¡®</div>';
                return;
            }

            // å…³é”®ä¿®å¤ï¼šæ¸…é™¤åŠ è½½çŠ¶æ€
            document.getElementById('chart').innerHTML = '';

            let y_data, y_title, y_range, y_dtick;

            if (currentMode === 'transmittance') {
                y_data = compound.y;
                y_title = 'é€è¿‡ç‡ (%)';
                y_range = [0, 100];
                y_dtick = 20;  // é€è¿‡ç‡æ¯20ä¸€æ ¼
            } else {
                y_data = compound.y.map(transmittance_to_absorbance);
                y_title = 'å¸å…‰åº¦ (A)';
                y_range = [0, 6];
                y_dtick = 0.5;  // å¸å…‰åº¦æ¯0.5ä¸€æ ¼
            }

            const trace = {
                x: compound.x,
                y: y_data,
                type: 'scatter',
                mode: 'lines',
                name: compound.name,
                line: { color: '#3498db', width: 2 }
            };

            const layout = {
                title: 'çº¢å¤–å…‰è°±å›¾',
                xaxis: { title: 'æ³¢æ•° (cmâ»Â¹)', autorange: 'reversed' },
                yaxis: { title: y_title, range: y_range, dtick: y_dtick },
                margin: { t: 50, r: 30, b: 50, l: 60 }
            };

            // é”€æ¯æ—§å›¾è¡¨
            try {
                Plotly.purge('chart');
            } catch (e) {}

            Plotly.newPlot('chart', [trace], layout);

            // ============================================================================
            // ä¸‹è½½æŒ‰é’®åˆ›å»ºï¼ˆå…³é”®ä¿®å¤ï¼šç‹¬ç«‹åˆ›å»ºï¼Œä¸ä¾èµ–setTimeoutï¼‰
            // ============================================================================
            createDownloadButtons(compound);
        }

        // ============================================================================
        // ä¸‹è½½æŒ‰é’®åˆ›å»ºï¼ˆä¿®å¤ï¼šç‹¬ç«‹å‡½æ•°ï¼Œç¡®ä¿æ‰§è¡Œï¼‰
        // ============================================================================
        function createDownloadButtons(compound) {
            const chartDiv = document.getElementById('chart');
            const plotlyChartDiv = document.getElementById('plotly-chart');

            // ç§»é™¤æ—§æŒ‰é’®
            const oldButtons = plotlyChartDiv.querySelector('.download-buttons');
            if (oldButtons) oldButtons.remove();

            // åˆ›å»ºæ–°æŒ‰é’®å®¹å™¨
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'download-buttons';

            buttonDiv.innerHTML = `
                <button class="btn-csv" onclick="downloadCSV('${compound.name}', ${JSON.stringify(compound.x)}, ${JSON.stringify(compound.y)})">
                    ğŸ“¥ ä¸‹è½½CSVæ•°æ®
                </button>
                <button class="btn-png" onclick="downloadPNG('${compound.name}')">
                    ğŸ–¼ï¸ ä¸‹è½½PNGå›¾ç‰‡
                </button>
            `;

            // å°†æŒ‰é’®æ·»åŠ åˆ°å›¾è¡¨ä¸‹æ–¹
            plotlyChartDiv.insertBefore(buttonDiv, plotlyChartDiv.lastElementChild);
        }

        // ============================================================================
        // æœç´¢åŠŸèƒ½
        // ============================================================================
        function searchCompounds() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!query) {
                displayCompounds(spectraIndex);
                return;
            }

            if (!spectraIndex || !spectraIndex.length) return;

            const filtered = spectraIndex.filter(c =>
                c.name.toLowerCase().includes(query)
            );
            displayCompounds(filtered);
        }

        // ============================================================================
        // åˆ‡æ¢Yè½´æ¨¡å¼
        // ============================================================================
        function toggleYAxisMode() {
            if (!currentCompound) {
                alert('è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªåŒ–åˆç‰©æ ·å“ï¼Œå†åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼ï¼');
                return;
            }

            const btn = document.getElementById('toggleModeBtn');

            if (currentMode === 'transmittance') {
                currentMode = 'absorbance';
                btn.textContent = 'åˆ‡æ¢åˆ°é€è¿‡ç‡';
            } else {
                currentMode = 'transmittance';
                btn.textContent = 'åˆ‡æ¢åˆ°å¸å…‰åº¦';
            }

            showSpectrum(currentCompound);
        }

        // ============================================================================
        // ä¸‹è½½åŠŸèƒ½ï¼ˆä¿®å¤ï¼šç¡®ä¿æ•°æ®æœ‰æ•ˆï¼‰
        // ============================================================================

        // ä¸‹è½½CSVæ–‡ä»¶
        function downloadCSV(compoundName, xData, yData) {
            // é˜²å¾¡æ€§æ£€æŸ¥
            if (!xData || !yData || xData.length === 0 || xData.length !== yData.length) {
                alert('é”™è¯¯ï¼šæ•°æ®ä¸å®Œæ•´æˆ–æ ¼å¼ä¸æ­£ç¡®');
                return;
            }

            // ç”ŸæˆCSVå†…å®¹
            let csvContent = "Wavenumber (cm-1),Transmittance (%)\n";
            for (let i = 0; i < xData.length; i++) {
                csvContent += `${xData[i]},${yData[i]}\n`;
            }

            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${compoundName.replace(/[/\\?%*:|"<>]/g, '_')}_å…‰è°±æ•°æ®.csv`);
            link.style.visibility = 'hidden';

            // è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // é‡Šæ”¾å†…å­˜
            setTimeout(() => URL.revokeObjectURL(url), 100);

            console.log(`âœ… CSVä¸‹è½½å·²è§¦å‘: ${compoundName}`);
        }

        // ä¸‹è½½PNGå›¾ç‰‡ï¼ˆä½¿ç”¨Plotlyè‡ªå¸¦åŠŸèƒ½ï¼‰
        function downloadPNG(compoundName) {
            const chartDiv = document.getElementById('chart');

            // æ£€æŸ¥æ˜¯å¦æœ‰å›¾è¡¨
            if (!chartDiv.data || chartDiv.data.length === 0) {
                alert('è¯·å…ˆæ˜¾ç¤ºè°±å›¾å†ä¸‹è½½å›¾ç‰‡');
                return;
            }

            // ä½¿ç”¨Plotlyçš„ä¸‹è½½åŠŸèƒ½
            Plotly.downloadImage(chartDiv, {
                format: 'png',
                width: 1200,
                height: 700,
                filename: `${compoundName.replace(/[/\\?%*:|"<>]/g, '_')}_çº¢å¤–å…‰è°±å›¾`
            });

            console.log(`âœ… PNGä¸‹è½½å·²è§¦å‘: ${compoundName}`);
        }
   // ============================================================================
// ä¸Šä¼ åŠŸèƒ½ï¼ˆVercel APIï¼‰
// ============================================================================

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('csvFile');
    const formulaInput = document.getElementById('formulaInput');
    const statusDiv = document.getElementById('uploadStatus');

    // éªŒè¯
    if (!fileInput.files[0]) {
        statusDiv.innerHTML = '<span style="color:red;">âŒ è¯·é€‰æ‹©CSVæ–‡ä»¶</span>';
        return;
    }

    statusDiv.innerHTML = '<span style="color:blue;">â³ æ­£åœ¨ä¸Šä¼ ...</span>';

    try {
        // è¯»å–æ–‡ä»¶ä¸ºBase64
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function(e) {
            // è½¬æ¢ä¸ºBase64ï¼ˆå»é™¤data URLå‰ç¼€ï¼‰
            const base64Data = btoa(e.target.result);

            // è°ƒç”¨ä¸Šä¼ APIï¼ˆVercelä¼šè‡ªåŠ¨å¤„ç†è·¯ç”±ï¼‰
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fileName: file.name,
                    fileData: base64Data,
                    formula: formulaInput.value || 'æœªçŸ¥'
                })
            });

            const result = await response.json();

            if (result.success) {
                statusDiv.innerHTML = '<span style="color:green;">âœ… ä¸Šä¼ æˆåŠŸï¼2ç§’ååˆ·æ–°æ•°æ®...</span>';
                // æ¸…ç©ºè¡¨å•
                fileInput.value = '';
                formulaInput.value = '';
                // é‡æ–°åŠ è½½æ•°æ®ï¼ˆç®€å•åˆ·æ–°ï¼‰
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                statusDiv.innerHTML = `<span style="color:red;">âŒ ä¸Šä¼ å¤±è´¥: ${result.error}</span>`;
                console.error('ä¸Šä¼ å¤±è´¥:', result);
            }
        };

        reader.onerror = function() {
            statusDiv.innerHTML = '<span style="color:red;">âŒ æ–‡ä»¶è¯»å–å¤±è´¥</span>';
        };

        reader.readAsBinaryString(file);

    } catch (error) {
        statusDiv.innerHTML = `<span style="color:red;">âŒ é”™è¯¯: ${error.message}</span>`;
        console.error('ä¸Šä¼ é”™è¯¯:', error);
    }
});
    </script>
</body>
</html>